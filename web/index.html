<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="plane_button.css">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title>DMOD Enterprises</title>
</head>

<script type="application/javascript">

  var global_current_mode;

  window.onload = function () {
    update_sign_status();
    update_brightness_slider();

  document.getElementById("config").onsubmit = function(e) {
    e.preventDefault();
    var confdiv = document.getElementById("config");
    var str ="";
    for (let i = 0; i < confdiv.children.length-1; i++) { 
      str+=String(confdiv.children[i].children[0].textContent).slice(0, -2).replaceAll(' ', '_');
      str+="=";
      if(confdiv.children[i].children[1].type=="checkbox")
      {
        str+=String(confdiv.children[i].children[1].checked);
      }else{
        str+=String(confdiv.children[i].children[1].value);
      }
      str+="&";
    }
    str=str.slice(0,-1);
    
    call_endpoint("/write_config?" + str);
  }

    document.getElementById("brightness_slider").oninput = function () {
      call_endpoint("/set_brightness/" + this.value);
    }

    document.getElementById("custom_message").oninput = function () {
      call_endpoint("/set_custom_message/" + encodeURIComponent(this.value));
    }

    document.getElementById("pong_player1_slider").oninput = function () {
      call_endpoint("/set_pong_player_1/" + encodeURIComponent(this.value));
    }

    document.getElementById("pong_player2_slider").oninput = function () {
      call_endpoint("/set_pong_player_2/" + encodeURIComponent(this.value));
    }

    document.getElementById("lightning_slider").oninput = function () {
      call_endpoint("/lightning/" + this.value);
    }

    toggle_switch.onchange = function () {
      if (document.getElementById("toggle_switch").checked) {
        call_endpoint('/turn_on')
      } else {
        call_endpoint('/turn_off')
      }
    }

  }

  function submit_ticker() {
    call_endpoint("/submit_ticker/" + encodeURIComponent(document.getElementById("ticker").value));
    document.getElementById("ticker").value = "";
  }

  function call_endpoint(endpoint, callback) {
    var request = new XMLHttpRequest();
    request.onreadystatechange = function () {
      if (request.status == 200 && callback) {
        callback(request.responseText);
      }
    }
    request.open('GET', "api" + endpoint, true);
    request.send();
  }

  function update_brightness_slider() {
    call_endpoint("/get_brightness", function (value) {
      document.getElementById("brightness_slider").value = value;
    });
  }

  function set_mode(mode) {
    document.getElementById(global_current_mode).style.backgroundColor = "black"; // Turn off current button
    document.getElementById(mode).style.backgroundColor = "red"; // Turn on new button
    global_current_mode = mode;

    if (mode !== 8) {
      document.getElementById('custom_message_div').hidden = true;
    }
    if (mode !== 10) {
      document.getElementById('cgol_div').hidden = true;
    }
    if (mode !== 11) {
      document.getElementById('pong_div').hidden = true;
    }
    if (mode !== 13) {
      document.getElementById('finance_div').hidden = true;
    }
    if (mode !== 15) {
      document.getElementById('lightning_div').hidden = true;
    }
    if (mode !== 99) {
      document.getElementById('track-a-flight_div').hidden = true;
    }
    if (mode == 10){
      var ele = document.getElementsByName('cgolstyle');
      for(i = 0; i < ele.length; i++) {
          if(ele[i].checked)
            break;
      }
      call_endpoint("/set_mode/" + mode +"?style=" + ele[i].value);
    } else {
      call_endpoint("/set_mode/" + mode);
    }
  }

  function set_color_mode(color) {
      call_endpoint("/set_color_mode/" + color);
  }

  function showoptions() {
    read_conf()
    document.getElementById("optionsSidebar").style.display = "block";
  }

  function hideoptions() {
    document.getElementById("optionsSidebar").style.display = "none";
  }

  function read_conf() {
    if (document.getElementById("config").childElementCount == 1 && document.getElementById("optionsSidebar").style.display == "none") {
      var xhr = new XMLHttpRequest()
      xhr.open("GET", "api/get_config", true);
      xhr.onreadystatechange = function () {
        if(xhr.readyState === XMLHttpRequest.DONE) {
          var status = xhr.status;
          if (status === 0 || (status >= 200 && status < 400)) {
            var value = xhr.responseText;

            var data = JSON.parse(value);
            var itm = document.getElementById("linetemplate");
            for (let i = 0; i < Object.keys(data).length; i++) { 
              //console.log(Object.keys(data)[i]);
              //console.log(data[Object.keys(data)[i]])
              //Skip extra junk in read_static_airport_data() dictionary not loaded from config file
              if (String(Object.keys(data)[i])=="DATATYPES" || String(Object.keys(data)[i])=="ENDPOINT" || String(Object.keys(data)[i])=="WEATHER_ENDPOINT") {
                continue
              }

              for(let j = 0; j < data.DATATYPES.length; j++)
              {
                if (data.DATATYPES[j].id == String(Object.keys(data)[i]))
                {
                  form_type = data.DATATYPES[j].type;
                  if(data.DATATYPES[j].hasOwnProperty('min'))
                  {
                    form_min = data.DATATYPES[j].min
                  }else{
                    form_min = null
                  }
                  if(data.DATATYPES[j].hasOwnProperty('max'))
                  {
                    form_max = data.DATATYPES[j].max
                  }else{
                    form_max = null
                  }
                  if(data.DATATYPES[j].hasOwnProperty('step'))
                  {
                    form_step = data.DATATYPES[j].step
                  }else{
                    form_step = null
                  }
                  break
                }else{
                  form_type = "text";
                }
              }

              var cln = itm.cloneNode(true);
              cln.style="display:block";
              cln.childNodes[1].textContent=String(Object.keys(data)[i]).replaceAll('_', ' ')+": ";
              cln.childNodes[1].for=String(Object.keys(data)[i]);
              cln.childNodes[2].type=form_type;
              cln.childNodes[2].name=String(Object.keys(data)[i]);
              cln.childNodes[2].id=String(Object.keys(data)[i]);
              if (form_type == "checkbox")
              {
                cln.childNodes[2].removeAttribute("value")
                cln.childNodes[2].checked=(String(data[Object.keys(data)[i]]).toLowerCase() === 'true');
              }else if(form_type == "number" || form_type == "range")
              {
                if(form_step != null){
                  cln.childNodes[2].step=form_step;
                }else{
                  if(form_type == "number") {cln.childNodes[2].step="any";}
                }
                if(form_min != null){
                  cln.childNodes[2].min=form_min;
                }
                if(form_max != null){
                  cln.childNodes[2].max=form_max;
                }
                cln.childNodes[2].value=String(data[Object.keys(data)[i]]);
              }else{
                cln.childNodes[2].value=String(data[Object.keys(data)[i]]);
              }
              
              document.getElementById("config").insertBefore(cln,document.getElementById("config").lastElementChild)
            }
      

            console.log(xhr.responseText);
          } else {
            console.log(xhr.responseText);
            // Oh no! There has been an error with the request!
          }
        }
      };
      xhr.send();
    }
  }

  function update_sign() {
    if (confirm('Are you sure you want to update?\n(Uncommitted sign updates will be lost)')) {
      call_endpoint("/update");
    }
  }

  function update_sign_status() {
    call_endpoint("/status", function (current_status) {
      if (current_status === "1") {
        document.getElementById("toggle_switch").checked = true;
      } else {
        document.getElementById("toggle_switch").checked = false;
      }
    });

    call_endpoint("/get_mode", function (current_mode) {
      if (current_mode){
        document.getElementById(current_mode).style.backgroundColor = "red";
        global_current_mode = current_mode;
      }
    });
  }
</script>

<body>
  <div id="title_header">Plane Sign</div>
  <div id="topbar">
    <div id="centered">
      <label id="header_switch" class="plane-switch">
        <input id="toggle_switch" type="checkbox">
        <div style="transform: scale(5);">
          <div>
            <svg>
              <path fill="currentColor" d="M1.55989957,5.41666667 L5.51582215,5.41666667 L4.47015462,0.108333333 L4.47015462,0.108333333 C4.47015462,0.0634601974 4.49708054,0.0249592654 4.5354546,0.00851337035 L4.57707145,0 L5.36229752,0 C5.43359776,0 5.50087375,0.028779451 5.55026392,0.0782711996 L5.59317877,0.134368264 L7.13659662,2.81558333 L8.29565964,2.81666667 C8.53185377,2.81666667 8.72332694,3.01067661 8.72332694,3.25 C8.72332694,3.48932339 8.53185377,3.68333333 8.29565964,3.68333333 L7.63589819,3.68225 L8.63450135,5.41666667 L11.9308317,5.41666667 C12.5213171,5.41666667 13,5.90169152 13,6.5 C13,7.09830848 12.5213171,7.58333333 11.9308317,7.58333333 L8.63450135,7.58333333 L7.63589819,9.31666667 L8.29565964,9.31666667 C8.53185377,9.31666667 8.72332694,9.51067661 8.72332694,9.75 C8.72332694,9.98932339 8.53185377,10.1833333 8.29565964,10.1833333 L7.13659662,10.1833333 L5.59317877,12.8656317 C5.55725264,12.9280353 5.49882018,12.9724157 5.43174295,12.9907056 L5.36229752,13 L4.57707145,13 L4.55610333,12.9978962 C4.51267695,12.9890959 4.48069792,12.9547924 4.47230803,12.9134397 L4.47223088,12.8704208 L5.51582215,7.58333333 L1.55989957,7.58333333 L0.891288881,8.55114605 C0.853775374,8.60544678 0.798421006,8.64327676 0.73629202,8.65879796 L0.672314689,8.66666667 L0.106844414,8.66666667 L0.0715243949,8.66058466 L0.0715243949,8.66058466 C0.0297243066,8.6457608 0.00275502199,8.60729104 0,8.5651586 L0.00593007386,8.52254537 L0.580855011,6.85813984 C0.64492547,6.67265611 0.6577034,6.47392717 0.619193545,6.28316421 L0.580694768,6.14191703 L0.00601851064,4.48064746 C0.00203480725,4.4691314 0,4.45701613 0,4.44481314 C0,4.39994001 0.0269259152,4.36143908 0.0652999725,4.34499318 L0.106916826,4.33647981 L0.672546853,4.33647981 C0.737865848,4.33647981 0.80011301,4.36066329 0.848265401,4.40322477 L0.89131128,4.45169723 L1.55989957,5.41666667 Z"></path>
            </svg>
          </div>
          <span class="street-middle"></span>
          <span class="cloud"></span>
          <span class="cloud two"></span>
        </div>
      </label>
    </div><div id="floating">
      <button type="submit" id="optionsbutton" onclick="showoptions(); return false;">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="grey" class="bi bi-gear" viewBox="0 0 16 16">
          <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
          <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319zm-2.633.283c.246-.835 1.428-.835 1.674 0l.094.319a1.873 1.873 0 0 0 2.693 1.115l.291-.16c.764-.415 1.6.42 1.184 1.185l-.159.292a1.873 1.873 0 0 0 1.116 2.692l.318.094c.835.246.835 1.428 0 1.674l-.319.094a1.873 1.873 0 0 0-1.115 2.693l.16.291c.415.764-.42 1.6-1.185 1.184l-.291-.159a1.873 1.873 0 0 0-2.693 1.116l-.094.318c-.246.835-1.428.835-1.674 0l-.094-.319a1.873 1.873 0 0 0-2.692-1.115l-.292.16c-.764.415-1.6-.42-1.184-1.185l.159-.291A1.873 1.873 0 0 0 1.945 8.93l-.319-.094c-.835-.246-.835-1.428 0-1.674l.319-.094A1.873 1.873 0 0 0 3.06 4.377l-.16-.292c-.415-.764.42-1.6 1.185-1.184l.292.159a1.873 1.873 0 0 0 2.692-1.115l.094-.319z"/>
        </svg>
      </button>
    </div>
  </div>
  

  <input id="brightness_slider" type="range" min="0" max="100" step="1" value="100">

  <div class="groups_wrapper">

    <fieldset class="mode_selector_button_group box1">
      <legend>Planes</legend>
      <button id="1" class="mode_button" onclick="set_mode(this.id)">Default Mode</button>
      <button id="2" class="mode_button" onclick="set_mode(this.id)">Show Closest</button>
      <button id="3" class="mode_button" onclick="set_mode(this.id)">Show Highest</button>
      <button id="4" class="mode_button" onclick="set_mode(this.id)">Show Fastest</button>
      <button id="5" class="mode_button" onclick="set_mode(this.id)">Show Slowest</button>
      <button id="99" class="mode_button" onclick="set_mode(this.id); document.getElementById('track-a-flight_div').hidden = false">Track-A-Flight™</button>
      <div id="track-a-flight_div" hidden>
        <input id="track-a-flight_flight-num"></input>
        <button onclick="call_endpoint('/set_track_a_flight/' + document.getElementById('track-a-flight_flight-num').value);">Track-It™</button>
      </div>
    </fieldset>

    <fieldset class="mode_selector_button_group box2">
      <legend>Informational</legend>
      <button id="6" class="mode_button" onclick="set_mode(this.id)">Weather</button>
      <button id="7" class="mode_button" onclick="set_mode(this.id)">Clock Only</button>
      <button id="15" class="mode_button" onclick="set_mode(this.id); document.getElementById('lightning_div').hidden = false">Lightning</button>
      <div id="lightning_div" hidden>
        <input id="lightning_slider" type="range" min="0" max="8" step="1" value="6">
      </div>
      <button id="13" class="mode_button" onclick="set_mode(this.id); document.getElementById('finance_div').hidden = false">Finance</button>
      <div id="finance_div" hidden>
        Ticker Symbol:<input type="text" id="ticker"></input>
        <button class="submit" onclick="submit_ticker();">Submit</button>
      </div>
    </fieldset>

    <fieldset class="mode_selector_button_group box3">
      <legend>Just for Fun :)</legend>
      <button id="8" class="mode_button" onclick="set_mode(this.id); document.getElementById('custom_message_div').hidden = false">Custom Message</button>
      <div id="custom_message_div" hidden>
        <div id="custom_message_buttons">
          <button class="custom_colors_button" onclick="set_color_mode(0)">Plain</button>
          <button class="custom_colors_button" onclick="set_color_mode(1)">🌈</button>
          <button class="custom_colors_button" onclick="set_color_mode(2)">🎄</button>
          <button class="custom_colors_button" onclick="set_color_mode(3)"><span style="color: rgb(173, 0, 30)">U</span><span style="color: rgb(108, 108, 108)">S</span><span style="color: rgb(37, 120, 178)">A</span></button>
          <button class="custom_colors_button" onclick="set_color_mode(4)">🎃</button>
          <input type="color" id="colorpicker" oninput="set_color_mode(5+parseInt(document.getElementById('colorpicker').value.substring(1), 16))" value="#ff0000" style="height: 30px;">
        </div>
        <br>
        <input type="text" id="custom_message"></input>
      </div>
      <button id="9" class="mode_button" onclick="set_mode(this.id)">Welcome Intro</button>
      <button id="10" class="mode_button" onclick="set_mode(this.id); document.getElementById('cgol_div').hidden = false">CGOL</button>
      <div id="cgol_div" hidden>
        <input type="radio" id="rainbowgol" name="cgolstyle" onclick="set_mode(10)" value="1" checked="checked">
        <label for="rainbowgol">Rainbow Rules</label>
        <input type="radio" id="colorshift" name="cgolstyle" onclick="set_mode(10)" value="2">
        <label for="colorshift">Color Shifting</label>
      </div>
      <button id="11" class="mode_button" onclick="set_mode(this.id); document.getElementById('pong_div').hidden = false">PONG!</button>
      <div id="pong_div" hidden>
        <input class="pong_slider" id="pong_player1_slider" type="range" min="0" max="26" step="1" value="0">
        <input class="pong_slider" id="pong_player2_slider" type="range" min="0" max="26" step="1" value="0">
      </div>
      <button id="12" class="mode_button" onclick="set_mode(this.id)">CCA</button>
      <button id="14" class="mode_button" onclick="set_mode(this.id)">Aquarium</button>
      <button id="16" class="mode_button" onclick="set_mode(this.id)">Fireworks</button>
    </fieldset>
  </div>
  <div class="sidenav" style="display:none" id="optionsSidebar">
    <button onclick="hideoptions()" class="closebutton">&times;</button>
    <button class="mode_button" onclick="update_sign()">UPDATE PLANESIGN</button>
    <span id="linetemplate" class="configline" style="display:none">
      <label for="templatename" class="configline"></label><input type="text" class="configline" id="templateid" name="templatename" value="">
    </span>
    <form id="config" name="config" method="get">
      <span id="config_button_span">
        <button id="submit_config_button" type="submit" class="configline">Update Config</button>
      </span>
    </form>

  </div>
</body>

</html>